interface
uses
  System, DispIntf, ConstNames, Интерфейс, Расчеты, Reports, InitColors;

implementation

const
  errUserBreak = 'Формирование отчета прекращено пользователем!';

Var
  Stores : ICValueList;
  GoodDict, S, Store : ICDictionary;
  PartionTbl, DocListTbl, PPartionTbl, PDocListTbl, PTable : ICValueTable;
  RepCurrent : ICProcessing;
  Constants : IC4VPAConst;
  CursorVis : TCursor;
  CursorsRefCount : Integer;
  IsZerro, LockStoreEdit : Boolean;

procedure CreateTblObjects;
Begin
  //партии товара 
  PDocListTbl := CreateObject('ТаблицаЗначений');
  PartionTbl := CreateObject('ТаблицаЗначений');
  CreatePartGoodTblCols(PartionTbl, False);
  PartionTbl.AddColumn('ДатаПр', vtcDate, 0);
  PartionTbl.AddColumn('СумВалВх', lftFFT, 7);
  PartionTbl.AddColumn('НазваниеПартнера', vtcString, 70);
  PartionTbl.AddColumn('СкладНазвание', vtcString, 50);
  SetFormatStdColumnsList(PartionTbl, 'КолОбщ', '0.####');
  SetFormatStdColumnsList(PartionTbl, 'ВхЦенаБезНДС;ВхЦенаВал;СумВх;СумВхНДС;СумОтп;СумОтпНДС,СумВалВх', '0.00##');
  PartionTbl.Open;
  PartionTbl.SortedColumns := 'ДатаПр;Склад;Партнер';
  //документы
  DocListTbl := CreateObject('ТаблицаЗначений');
  CreateDocsTblCols(DocListTbl, False);
  DocListTbl.AddColumn('Партнер', vtcLink, 0);
  DocListTbl.AddColumn('НазваниеПартнера', vtcString, 70);
  DocListTbl.AddColumn('НомерДокумента', vtcString, 20);
  DocListTbl.AddColumn('Цена', vtcFFt, 4);
  DocListTbl.AddColumn('Товар', vtcLink, 0);
  DocListTbl.AddColumn('Склад', vtcLink, 0);
  DocListTbl.AddColumn('Партия', vtcFloat, 0);
  DocListTbl.AddColumn('Отпуск', vtcInteger, 0);
  SetFormatStdColumnsList(DocListTbl, 'КолОбщ', '0.####');
  SetFormatStdColumnsList(DocListTbl, 'СумВх;СумВхНДС;СумОтпНДС;СумОтп;СумНакоп;СумНац;СумОбщ;Цена', '0.00##');
  DocListTbl.Open;
  DocListTbl.SortBy('Партнер;Date;Document;Партнер');
end;

procedure RunReport;
begin
  PartionTbl.Clear;
  DocListTbl.Clear;
  PartionTbl.CopyDataToServer;
  DocListTbl.CopyDataToServer;
  server.CreateSrvObjects(PartionTbl.SrvMean,DocListTbl.SrvMean);
  server.GetReportData(GoodDict,Store,IsZerro);
  server.SetPartScrollParams(PartionTbl.Партия, PartionTbl.@Партнер);
  PartionTbl.CopyDataFromServer;                             
  PartionTbl.SortBy('Партнер;ДатаПр');
  PartionTbl.UseDataSource(CtrlToVar(TVSPartGood)); 
  DocListTbl.CopyDataFromServer;
  DocListTbl.CopyTo('Date;Партнер;КолОбщ;Document;Цена;СумОтп;Партия',PDocListTbl);
end;

procedure TVSPartGood_VPATimedAfterScroll(Sender : TObject);
begin
  if not PartionTbl.IsFocused then
    exit;
  CursorsRefCount := UnuseCursor(CursorVis, CursorsRefCount);
  try
   // DocListTbl.CopyDataFromServer;
    DocListTbl.CancelRange;
    DocListTbl.SortBy('Партия;Date');
    DocListTbl.SetRange(PartionTbl.Партия,PartionTbl.Партия)
  finally
    DocListTbl.UseDataSource(CtrlToVar(TVSDoc));
    CursorsRefCount := UseCursor(CursorVis, CursorsRefCount);
  end;
end;

procedure Form_Execute(Sender : TObject; Mean : Variant; Params : Variant);
var
  InPriceNt, InPrice, InHdPrice : decimal;
  GoodName, Units, ГРН, ВалВх, ВалОтп : string;
begin
  Constants := GetConstants;
  CreateTblObjects;
  GoodDict := Params; //Спавочник товаров
  IsZerro := cbZeroRest.Checked;
//--------------------- Партнер----------------------
  LockStoreEdit := true;
  Stores := CreateObject('СписокЗначений');
  Store := CreateObject('Справочники.ОбъектыПроизводства');
  if VarAsBool(Params.HasParam('Store')) then
    if IsObjFocused(Params) then
      Store := Params.Params['Store'];
  S := CreateObject('Справочники.ОбъектыПроизводства');
  Stores.AddValue(Trans('Все объекты'), Null);
  S.Select;
  while S.SelectNext do
    Stores.AddValue(S.ПолноеНазвание, S); // или ('', S)
  Stores.UseControl(CtrlToVar(eStores));
  if IsObjFocused(Store) then
    Stores.CurIndex := Stores.FindByValue(Store)
  else
    Stores.CurIndex := 0;
  LockStoreEdit := false;
//--------------------------------------------------
  if VarAsBool(GoodDict.IsFocused) then
    begin
      if GoodDict.Код <> '' then
        GoodName := GoodDict.Код + ' ' + GoodDict.НазвТовара
      else
        GoodName := GoodDict.НазвТовара;
    end;
  lGoodNameWhite.Caption := GoodName;
  lGoodNameBlack.Caption := GoodName;
  RunReport;
  TVSPartGood_VPATimedAfterScroll(dbgDocs);
end;

procedure eStores_Change(Sender : TObject);
begin
  if not LockStoreEdit then
    begin
      GetStore(Stores, Store);
      RunReport;
    end;
end;

procedure cbZeroRest_Click(Sender : TObject);
begin
  IsZerro := cbZeroRest.Checked;
  RunReport;
end;

procedure pmiView_Click(Sender : TObject);
begin
  if VarAsBool(DocListTbl.IsFocused) then
    DocListTbl.Document.EditInForm(DocListTbl.Document.GetSign, 3);
end;

procedure pmiPrint_Click(Sender : TObject);
Var
  DocSign : String;
  V : ICProcessing;
begin
  if VarAsBool(DocListTbl.IsFocused) then
    begin
      DocSign := DocListTbl.Document.GetSign;
      Case DocSign of
        'СписаниеТовара':
          DocListTbl.Document.PrintForm('', not VarAsBool(GetOptions.GetServerPrm(DirectPrint)), DocListTbl.Document);
        'НакладнаяВнутрПеремещ':
          begin
            V := CreateObject('Обработки.ПечВнутрПеремещ');
            V.PrintForm('', not VarAsBool(GetOptions.GetServerPrm(DirectPrint)), DocListTbl.Document)
          end;
        'ВводОстатков':
          begin
            V := CreateObject('Обработки.ПечВводОстатков');
            V.PrintForm('', not VarAsBool(GetOptions.GetServerPrm(DirectPrint)), DocListTbl.Document)
          end;
//        'НакладнаяОтпуска','НакладнаяОтпускаПоСчету','НакладнаяОтпускаТМЦПоСчету',
//        'НакладнаяПрихода','НакладнаяПриходаСчету'
      else
        begin
          V := CreateObject('Обработки.ПечУнивНакладнаяОтпуска');
          V.PrintForm('', not VarAsBool(GetOptions.GetServerPrm(DirectPrint)), DocListTbl.Document)
        end;
      end
    end;
end;

{$D-}
procedure dbgDocs_GetImageIndex(Sender : TObject; var Index1, Index2 : integer);
begin
 if DocListTbl.Document.GetDocState = 0 then
   Index1 := 92
 else
   Index1 := 86;
//--------------------------------------------
 if DocListTbl.КолОбщ > 0 then
   Index2 := 82
 else
   Index2 := 83;
end;
{$D+}

{$D-}
procedure dbgPartGood_GetRowParams(Sender : TObject; DrawFont : TFont; var BackColor : TColor; Highlight : boolean);
begin
 if PartionTbl.IsFocused and (PartionTbl.КолОбщ <= 0) then
   if Highlight then
     begin
       BackColor:=BlZeroSel;
       DrawFont.Color := BlFZeroSel;
     end
   else
     begin
       BackColor:=BlZero;
       DrawFont.Color := BlFZero;
     end;
end;
{$D+}

procedure tbPrintAll_Click(Sender : TObject);
var
  V: ICProcessing;
begin
  PPartionTbl := CreateObject('ТаблицаЗначений');
  PDocListTbl := CreateObject('ТаблицаЗначений');
  PPartionTbl.Open;
  PPartionTbl.Clear;
  PDocListTbl.Open;
  PDocListTbl.Clear;
  PartionTbl.CopyTo('Партнер;ДатаПр;Партнер;КолОбщ;ВхЦенаБезНДС;ВхЦенаВал;Валюта;Партия',PPartionTbl);
  DocListTbl.CopyTo('Date;Партнер;КолОбщ;Document;Цена;СумОтп;Партия',PDocListTbl);
  PTable := CreateObject('ТаблицаЗначений');
  PTable.AddColumn('Партнер', vtcLink, 0);
  PTable.AddColumn('ДатаПр', vtcDate, 0);
  PTable.AddColumn('Склад', vtcLink, 0);
  PTable.AddColumn('КолОбщ', vtcFFt, 4);
  PTable.AddColumn('ВхЦенаБезНДС', vtcFFt, 4);
  PTable.AddColumn('ВхЦенаВал', vtcFFt, 4);
  PTable.AddColumn('Валюта', vtcString, 70);
  PTable.AddColumn('Партия', vtcFloat, 0);
  PTable.AddColumn('Date', vtcDate, 0);
  PTable.AddColumn('Document', vtcLink, 0);
  PTable.AddColumn('Цена', vtcFFt, 4);
  PTable.AddColumn('СумОтп', vtcFFt, 4);
  
  PTable.Params['StoreTbl'] := PPartionTbl;
  PTable.Params['DocTbl'] := PDocListTbl;
  PTable.Params['Good'] := lGoodNameWhite.Caption;

  V := CreateObject('Обработки.ДвижениеПоТовару');
  V.PrintForm('ПечДвиженияТовара', true, PTable)
end;

procedure tbExcel_Click(Sender : TObject);
var Excel, WorkBook, WorkSheet, TrgRange : Variant;
    i, j : integer;
    DataDir : string;
begin
  PPartionTbl := CreateObject('ТаблицаЗначений');
  PPartionTbl.Open;
  PPartionTbl.Clear;
  PPartionTbl.SelectFirst;
  PartionTbl.CopyTo('Склад;ДатаПр;Партнер;КолОбщ;ВхЦенаБезНДС;ВхЦенаВал;Валюта;Партия',PPartionTbl);
  PartionTbl.SelectFirst;
  Excel := CreateOleObject('Excel.Application');
  Excel.Visible := True;
  DataDir := ExtractFilePath(RunPath);
  Excel.WorkBooks.Open(DataDir+'ExcelTemplates\Движение товара.xls').WorkSheets(1).Copy;
  TrgRange := Excel.WorkBooks(2).WorkSheets(1).Range('A1:G3');
  TrgRange.Cells(2,1) := lGoodNameWhite.Caption;
  PPartionTbl.SelectFirst;
  PDocListTbl.SelectFirst;
  PPartionTbl.Select;
  i:=3;
  while PPartionTbl.SelectNext do begin
    j:=1;
       TrgRange.Cells(i,1).Borders.LineStyle := 1;
       TrgRange.Cells(i,1) := 'Партнер';
       TrgRange.Cells(i,2).Borders.LineStyle := 1;
       TrgRange.Cells(i,2) := 'Дата';
       TrgRange.Cells(i,3).Borders.LineStyle := 1;
       TrgRange.Cells(i,3) := 'Постачальник';
       TrgRange.Cells(i,4).Borders.LineStyle := 1;
       TrgRange.Cells(i,4) := 'К-ть';
       TrgRange.Cells(i,5).Borders.LineStyle := 1;
       TrgRange.Cells(i,5) := 'Вх. ціна без ПДВ';
       TrgRange.Cells(i,6).Borders.LineStyle := 1;
       TrgRange.Cells(i,6) := 'Вх. ціна (вал)';
       TrgRange.Cells(i,7).Borders.LineStyle := 1;
       TrgRange.Cells(i,7) := 'Валюта';
         TrgRange.Cells(i,1).Borders.LineStyle := 1;TrgRange.Cells(i,1).Font.Bold := true;TrgRange.Cells(i,1).Interior.Color := 9815293;
         TrgRange.Cells(i,2).Borders.LineStyle := 1;TrgRange.Cells(i,2).Font.Bold := true;TrgRange.Cells(i,2).Interior.Color := 9815293;
         TrgRange.Cells(i,3).Borders.LineStyle := 1;TrgRange.Cells(i,3).Font.Bold := true;TrgRange.Cells(i,3).Interior.Color := 9815293;
         TrgRange.Cells(i,4).Borders.LineStyle := 1;TrgRange.Cells(i,4).Font.Bold := true;TrgRange.Cells(i,4).Interior.Color := 9815293;
         TrgRange.Cells(i,5).Borders.LineStyle := 1;TrgRange.Cells(i,5).Font.Bold := true;TrgRange.Cells(i,5).Interior.Color := 9815293;
         TrgRange.Cells(i,6).Borders.LineStyle := 1;TrgRange.Cells(i,6).Font.Bold := true;TrgRange.Cells(i,6).Interior.Color := 9815293;
         TrgRange.Cells(i,7).Borders.LineStyle := 1;TrgRange.Cells(i,7).Font.Bold := true;TrgRange.Cells(i,7).Interior.Color := 9815293;
         for j := 1 to 7 do
             TrgRange.Cells(i,j).HorizontalAlignment := 3;
             TrgRange.Cells(i,j).VerticalAlignment := taCenter;
       inc(i);
       TrgRange.Cells(i,1) := GetPartName(PPartionTbl.Партнер);
       TrgRange.Cells(i,2) := PPartionTbl.ДатаПр;
       if VarAsBool(PPartionTbl.Склад.IsFocused) then
         TrgRange.Cells(i,3) := PPartionTbl.Склад.ПолноеНазвание;
       TrgRange.Cells(i,4) := PPartionTbl.КолОбщ;
       TrgRange.Cells(i,5) := PPartionTbl.ВхЦенаБезНДС;
       TrgRange.Cells(i,6) := PPartionTbl.ВхЦенаВал;
       TrgRange.Cells(i,7) := PPartionTbl.Валюта.Код;
         TrgRange.Cells(i,1).Borders.LineStyle := 1;
         TrgRange.Cells(i,2).Borders.LineStyle := 1;
         TrgRange.Cells(i,3).Borders.LineStyle := 1;
         TrgRange.Cells(i,4).Borders.LineStyle := 1;
         TrgRange.Cells(i,5).Borders.LineStyle := 1;
         TrgRange.Cells(i,6).Borders.LineStyle := 1;
         TrgRange.Cells(i,7).Borders.LineStyle := 1;
         TrgRange.Cells(i,2).HorizontalAlignment := 3;
         TrgRange.Cells(i,4).HorizontalAlignment := 1;
       inc(i);
       PDocListTbl.CancelRange;
       PDocListTbl.SortBy('Партия');
       PDocListTbl.SetRange(PPartionTbl.Партия,PPartionTbl.Партия);
           TrgRange.Cells(i,2).Borders.LineStyle := 1;
           TrgRange.Cells(i,2) := 'Дата';
           TrgRange.Cells(i,3).Borders.LineStyle := 1;
           TrgRange.Cells(i,3) := 'Документ';
           TrgRange.Cells(i,4).Borders.LineStyle := 1;
           TrgRange.Cells(i,4) := 'Партнер';
           TrgRange.Cells(i,5).Borders.LineStyle := 1;
           TrgRange.Cells(i,5) := 'К-ть';
           TrgRange.Cells(i,6).Borders.LineStyle := 1;
           TrgRange.Cells(i,6) := 'Ціна з ПДВ';
           TrgRange.Cells(i,7).Borders.LineStyle := 1;
           TrgRange.Cells(i,7) := 'Сума з ПДВ';  
         TrgRange.Cells(i,2).Borders.LineStyle := 1;TrgRange.Cells(i,2).Font.Bold := true;TrgRange.Cells(i,2).Interior.Color := 12058551;
         TrgRange.Cells(i,3).Borders.LineStyle := 1;TrgRange.Cells(i,3).Font.Bold := true;TrgRange.Cells(i,3).Interior.Color := 12058551;
         TrgRange.Cells(i,4).Borders.LineStyle := 1;TrgRange.Cells(i,4).Font.Bold := true;TrgRange.Cells(i,4).Interior.Color := 12058551;
         TrgRange.Cells(i,5).Borders.LineStyle := 1;TrgRange.Cells(i,5).Font.Bold := true;TrgRange.Cells(i,5).Interior.Color := 12058551;
         TrgRange.Cells(i,6).Borders.LineStyle := 1;TrgRange.Cells(i,6).Font.Bold := true;TrgRange.Cells(i,6).Interior.Color := 12058551;
         TrgRange.Cells(i,7).Borders.LineStyle := 1;TrgRange.Cells(i,7).Font.Bold := true;TrgRange.Cells(i,7).Interior.Color := 12058551;
         for j := 2 to 7 do
             TrgRange.Cells(i,j).HorizontalAlignment := 3;
             TrgRange.Cells(i,j).VerticalAlignment := taCenter;
       inc(i);
       PDocListTbl.Select;
       while PDocListTbl.SelectNext do
         begin
           TrgRange.Cells(i,2) := PDocListTbl.Date;  
           TrgRange.Cells(i,3) := PDocListTbl.Document.GetName + PDocListTbl.Document.НомерДокумента;
           TrgRange.Cells(i,4) := GetPartName(PDocListTbl.Партнер);
           TrgRange.Cells(i,5) := PDocListTbl.КолОбщ;
           TrgRange.Cells(i,6) := PDocListTbl.Цена;
           TrgRange.Cells(i,7) := PDocListTbl.СумОтп;
             TrgRange.Cells(i,2).Borders.LineStyle := 1;TrgRange.Cells(i,7).Borders.LineStyle := 1;
             TrgRange.Cells(i,3).Borders.LineStyle := 1;TrgRange.Cells(i,4).Borders.LineStyle := 1;
             TrgRange.Cells(i,5).Borders.LineStyle := 1;TrgRange.Cells(i,6).Borders.LineStyle := 1; 
             TrgRange.Cells(i,2).HorizontalAlignment := 3;
             TrgRange.Cells(i,2).VerticalAlignment := taCenter;
           inc(i);
         end;
     //  inc(i);
   end;
   Excel.WorkBooks(1).Close;
   TrgRange := Null;
   Excel := Null;
end;

end.
_VPA_COMPONENTTLIST_DELIMITER_Form:TO4Form
Panel5:TO4Panel
Splitter3:TO4Splitter
Label3:TO4Label
Label4:TO4Label
dbgPartGood:TO4DBGrid
Panel1:TO4Panel
lbGoodName:TO4Label
lGoodNameBlack:TO4Label
lGoodNameWhite:TO4Label
GroupBox2:TO4GroupBox
eStores:TO4Edit
cbZeroRest:TO4CheckBox
Panel2:TO4Panel
dbgDocs:TO4DBGrid
tbrData1:TO4ToolBar
tbView:TO4ToolButton
ToolButton3:TO4ToolButton
tbPrint:TO4ToolButton
tbParam1:TO4ToolButton
tbrData:TO4ToolBar
ToolButton1:TO4ToolButton
ToolButton2:TO4ToolButton
tbExcel:TO4ToolButton
TVSPartGood:TO4TableValueSource
TVSDoc:TO4TableValueSource
pmDocs:TO4PopupMenu
pmiView:TO4MenuItem
MenuItem2:TO4MenuItem
pmiPrint:TO4MenuItem
